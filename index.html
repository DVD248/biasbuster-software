<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>BiasBuster 2.2 ‚Ä¢ Tone ¬∑ Bias ¬∑ Balance</title>
<style>
  :root {
    --bg-page: #0f172a;
    --bg-card: #1e253a;
    --bg-inner: #0f172a;
    --border-card: rgba(255,255,255,0.07);
    --text-primary: #f8fafc;
    --text-secondary: #94a3b8;
    --text-dim: #64748b;
    --radius-lg: 1rem;
    --radius-md: .75rem;
    --radius-sm: .5rem;
    --tone-positive: hsl(140,70%,40%);
    --tone-neutral: hsl(45,85%,55%);
    --tone-negative: hsl(0,80%,55%);
    --bias-low: hsl(150,70%,40%);
    --bias-medium: hsl(45,85%,55%);
    --bias-high: hsl(0,80%,55%);
    --fair-good: hsl(150,70%,40%);
    --fair-warn: hsl(45,85%,55%);
    --fair-bad: hsl(0,80%,55%);
    --shadow-card: 0 30px 80px rgba(0,0,0,.6);
    --shadow-pop: 0 30px 80px rgba(0,0,0,.85);
    --accent-btn-start: #4ade80;
    --accent-btn-end: #166534;
  }

  * { box-sizing: border-box; }

  body {
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background: var(--bg-page);
    color: var(--text-primary);
    margin: 0;
    padding: 2rem;
    display: grid;
    place-items: start center;
  }

  .app {
    width: 100%;
    max-width: 1100px;
    display: grid;
    gap: 1.5rem;
  }

  h1 {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 .5rem 0;
  }

  .subhead {
    font-size: .8rem;
    color: var(--text-secondary);
    line-height: 1.4;
    margin: 0 0 1rem 0;
  }

  .card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-card);
    box-shadow: var(--shadow-card);
    padding: 1rem 1.25rem;
  }

  label {
    font-size: .75rem;
    font-weight: 500;
    color: var(--text-secondary);
    display: block;
    margin-bottom: .5rem;
  }

  textarea {
    width: 100%;
    min-height: 160px;
    background: var(--bg-inner);
    color: var(--text-primary);
    border-radius: var(--radius-md);
    border: 1px solid rgba(255,255,255,.1);
    padding: .75rem 1rem;
    line-height: 1.4;
    font-size: .9rem;
    resize: vertical;
  }

  textarea:focus {
    outline: 2px solid #38bdf8;
    border-color: transparent;
  }

  button {
    all: unset;
    cursor: pointer;
    background: radial-gradient(circle at 20% 20%, var(--accent-btn-start) 0%, var(--accent-btn-end) 60%);
    color: #ecfdf5;
    font-weight: 600;
    font-size: .9rem;
    padding: .6rem 1rem;
    border-radius: var(--radius-md);
    box-shadow: 0 20px 40px rgba(16,185,129,.4);
    display: inline-block;
    margin-top: .75rem;
    text-align: center;
  }

  button:active {
    transform: scale(.98);
  }

  /* SUMMARY SECTION */

  .summaryGrid {
    display: grid;
    gap: 1rem;
  }

  @media(min-width:768px){
    .summaryGrid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .summaryCardInner {
    background: var(--bg-inner);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-card);
    padding: .75rem 1rem;
    line-height: 1.5;
    font-size: .85rem;
  }

  .summaryRow {
    display: flex;
    flex-wrap: wrap;
    font-size: .8rem;
    margin-bottom: .5rem;
    gap: .5rem 1rem;
  }

  .badgeGroup {
    display: flex;
    flex-direction: column;
    gap: .4rem;
  }

  .badgeLabel {
    color: var(--text-secondary);
    font-size: .7rem;
    font-weight: 500;
    line-height: 1.2;
  }

  .badgeValue {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    font-size: .8rem;
    font-weight: 600;
    color: var(--text-primary);
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.1);
    border-radius: var(--radius-md);
    padding: .4rem .6rem;
  }

  .dot {
    width: .6rem;
    height: .6rem;
    border-radius: .4rem;
    flex-shrink: 0;
  }

  .toneDotPositive { background: var(--tone-positive); }
  .toneDotNeutral  { background: var(--tone-neutral); }
  .toneDotNegative { background: var(--tone-negative); }

  .biasDotLow     { background: var(--bias-low); }
  .biasDotMedium  { background: var(--bias-medium); }
  .biasDotHigh    { background: var(--bias-high); }

  .fairDotGood    { background: var(--fair-good); }
  .fairDotWarn    { background: var(--fair-warn); }
  .fairDotBad     { background: var(--fair-bad); }

  .whatMeansTitle {
    font-size: .7rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin: 0 0 .25rem 0;
  }

  .whatMeansBody {
    font-size: .8rem;
    line-height: 1.5;
    color: var(--text-primary);
    margin: 0;
  }

  /* INLINE HIGHLIGHT VIEW */

  .inlineWrapper {
    background: var(--bg-inner);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-card);
    padding: 1rem;
    min-height: 120px;
    line-height: 1.6;
    font-size: .9rem;
    position: relative;
    color: var(--text-primary);
  }

  .hintRow {
    display: flex;
    flex-wrap: wrap;
    gap: .75rem 1rem;
    margin-top: .75rem;
    font-size: .7rem;
    color: var(--text-secondary);
  }

  .hintItem {
    display: flex;
    align-items: center;
    gap: .4rem;
  }

  .hintSwatch {
    width: .75rem;
    height: .75rem;
    border-radius: .3rem;
    border: 1px solid rgba(0,0,0,.4);
  }

  /* span with tooltip */

  .hlSentence {
    position: relative;
    border-radius: .4rem;
    padding: .15rem .25rem;
    cursor: default;
    transition: box-shadow .15s;
    color: #0f172a;
    font-weight: 500;
  }

  .hlSentence:hover {
    box-shadow: 0 0 0 2px rgba(255,255,255,.4), 0 15px 40px rgba(0,0,0,.8);
    z-index: 5;
  }

  .tooltip {
    position: absolute;
    left: 0;
    top: calc(100% + 4px);
    background: var(--bg-card);
    color: var(--text-primary);
    font-size: .7rem;
    line-height: 1.4;
    padding: .5rem .6rem;
    border-radius: .5rem;
    min-width: 190px;
    max-width: 240px;
    box-shadow: var(--shadow-pop);
    border: 1px solid rgba(255,255,255,.1);
    opacity: 0;
    pointer-events: none;
    transition: opacity .12s;
    z-index: 10;
  }

  .hlSentence:hover .tooltip {
    opacity: 1;
  }

  /* TABLE */

  .tableWrapper {
    overflow-x: auto;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-card);
    background: var(--bg-inner);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px;
    font-size: .75rem;
    color: var(--text-primary);
  }

  thead th {
    background: var(--bg-card);
    font-weight: 600;
    text-align: left;
    color: var(--text-secondary);
    padding: .6rem .75rem;
    border-bottom: 1px solid var(--border-card);
    white-space: nowrap;
  }

  tbody td {
    padding: .6rem .75rem;
    border-bottom: 1px solid rgba(255,255,255,.07);
    vertical-align: top;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  .tdSentence {
    color: var(--text-primary);
    max-width: 350px;
    line-height: 1.4;
  }

  .labelPill {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    border-radius: .4rem;
    padding: .25rem .4rem;
    font-size: .7rem;
    font-weight: 500;
    border: 1px solid rgba(255,255,255,.15);
    color: #0f172a;
    line-height: 1.2;
  }

  /* we will inline background color from JS */

  .noteText {
    font-size: .7rem;
    line-height: 1.4;
    color: var(--text-secondary);
  }

  /* helper small text */
  .dim {
    color: var(--text-secondary);
    font-size: .7rem;
    line-height: 1.4;
  }

</style>
</head>
<!-- === Secret BiasBuster Developer Panel === -->
<!-- === BiasBuster Lab Mode (Dev Panel) START === -->
<div id="dev-tools" style="
  display:none; position:fixed; bottom:25px; right:25px;
  background:#1e1e1e; color:#eee; padding:20px; border-radius:16px;
  box-shadow:0 4px 16px rgba(0,0,0,0.6); z-index:9999; width:360px;
  font-family:system-ui, sans-serif; font-size:13px; max-height:90vh; overflow-y:auto;
">
  <h3 style="margin:0 0 12px; font-size:15px; display:flex;align-items:center;justify-content:space-between;">
    <span>üß© BiasBuster Lab Mode</span>
    <button id="close-dev" style="background:#333;border:0;border-radius:6px;color:#aaa;font-size:11px;padding:4px 6px;cursor:pointer;">‚úï</button>
  </h3>

  <!-- Preset row -->
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
    <label style="flex:1 1 auto;">Preset:
      <select id="preset-select" style="width:100%;margin-top:4px;background:#2a2a2a;color:#fff;border:1px solid #444;border-radius:6px;padding:4px 6px;font-size:12px;">
        <option value="custom">Custom</option>
        <option value="lenient">Lenient</option>
        <option value="balanced" selected>Balanced</option>
        <option value="strict">Strict</option>
      </select>
    </label>
  </div>

  <!-- Save / Load preset row -->
  <div style="display:flex;justify-content:space-between;gap:8px;margin-bottom:12px;">
    <button id="save-preset-btn" style="flex:1;background:#444;border:0;border-radius:6px;color:#fff;font-size:12px;padding:6px 8px;cursor:pointer;">
      ‚¨á Save Preset
    </button>
    <button id="load-preset-file-btn" style="flex:1;background:#444;border:0;border-radius:6px;color:#fff;font-size:12px;padding:6px 8px;cursor:pointer;">
      ‚¨Ü Load Preset
    </button>
    <!-- hidden file input for loading -->
    <input id="preset-file-input" type="file" accept="application/json" style="display:none;">
  </div>

  <hr style="border-color:#444;margin:10px 0;">

  <!-- SCORING -->
  <h4 style="margin:8px 0;">üéö Scoring Sensitivity</h4>

  <label style="display:block;margin-bottom:8px;">
    Bias High Threshold
    <input id="bias-high" type="range" min="0" max="1" step="0.01" style="width:100%">
    <span id="bias-high-val"></span>
  </label>

  <label style="display:block;margin-bottom:8px;">
    Fair Balanced Min (%)
    <input id="fair-balanced" type="range" min="50" max="100" step="1" style="width:100%">
    <span id="fair-balanced-val"></span>
  </label>

  <label style="display:block;margin-bottom:8px;">
    Hostile Penalty
    <input id="hostile-penalty" type="range" min="0" max="100" step="5" style="width:100%">
    <span id="hostile-penalty-val"></span>
  </label>

  <label style="display:block;margin-bottom:8px;">
    Favouritism Penalty
    <input id="fav-penalty" type="range" min="0" max="100" step="5" style="width:100%">
    <span id="fav-penalty-val"></span>
  </label>

  <label style="display:block;margin-bottom:8px;">
    Subjectivity Penalty
    <input id="subj-penalty" type="range" min="0" max="100" step="5" style="width:100%">
    <span id="subj-penalty-val"></span>
  </label>

  <label style="display:block;margin-bottom:8px;">
    Constructive Boost
    <input id="constructive-boost" type="range" min="0" max="1" step="0.05" style="width:100%">
    <span id="constructive-boost-val"></span>
  </label>

  <hr style="border-color:#444;margin:10px 0;">

  <!-- TONE -->
  <h4 style="margin:8px 0;">üß† Tone & Fairness Dynamics</h4>

  <label style="display:block;margin-bottom:8px;">
    Tone Variance Limit
    <input id="tone-var" type="range" min="0" max="1" step="0.05" style="width:100%">
    <span id="tone-var-val"></span>
  </label>

  <label style="display:block;margin-bottom:8px;">
    Extreme Tone Boost
    <input id="tone-extreme" type="range" min="0" max="0.3" step="0.01" style="width:100%">
    <span id="tone-extreme-val"></span>
  </label>

  <label style="display:block;margin-bottom:8px;">
    Rule Boost Multiplier
    <input id="rule-boost" type="range" min="0" max="1" step="0.05" style="width:100%">
    <span id="rule-boost-val"></span>
  </label>

  <hr style="border-color:#444;margin:10px 0;">

  <!-- COLORS -->
  <h4 style="margin:8px 0;">üé® Color Mapping</h4>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
    <span>Bias - Low</span>
    <input id="color-bias-low" type="color" value="#00c36b" style="border:0;background:none;">
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
    <span>Bias - Medium</span>
    <input id="color-bias-med" type="color" value="#ffb700" style="border:0;background:none;">
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
    <span>Bias - High</span>
    <input id="color-bias-high" type="color" value="#ff3838" style="border:0;background:none;">
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
    <span>Fair - Balanced</span>
    <input id="color-fair-good" type="color" value="#00c36b" style="border:0;background:none;">
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
    <span>Fair - Slightly Skewed</span>
    <input id="color-fair-mid" type="color" value="#ffb700" style="border:0;background:none;">
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
    <span>Fair - Unbalanced</span>
    <input id="color-fair-bad" type="color" value="#ff3838" style="border:0;background:none;">
  </div>

  <label style="display:block;margin-bottom:8px;">
    Tone Base Hue (0-120)
    <input id="tone-base-hue" type="range" min="0" max="120" step="5" style="width:100%">
    <span id="tone-base-hue-val"></span>
  </label>

  <hr style="border-color:#444;margin:10px 0;">

  <!-- bottom row -->
  <div style="display:flex;justify-content:space-between;gap:8px;">
    <button id="load-btn" style="flex:1;background:#444;border:0;border-radius:6px;color:#fff;font-size:12px;padding:6px 8px;cursor:pointer;">
      Refresh
    </button>
    <button id="reset-btn" style="flex:1;background:#444;border:0;border-radius:6px;color:#fff;font-size:12px;padding:6px 8px;cursor:pointer;">
      Reset
    </button>
  </div>
</div>

<script>
let devVisible = false;
let secretCount = 0;
const devPanel = document.getElementById("dev-tools");

// Map panel controls -> actual backend parameter keys
// Map panel controls -> actual backend parameter keys
const paramElems = {
  // --- Bias calibration ---
  "BIAS_HIGH_THRESHOLD": "bias-high",
  "FAIR_BALANCED_MIN": "fair-balanced",
  "HOSTILE_PENALTY": "hostile-penalty",
  "FAV_PENALTY": "fav-penalty",
  "SUBJECTIVE_PENALTY": "subj-penalty",

  // --- Constructive / fairness ---
  "CONSTRUCTIVE_BOOST": "constructive-boost",

  // --- Tone & bias ---
  "TONE_VARIANCE_LIMIT": "tone-var",
  "EXTREME_POLARITY_BIAS_BOOST": "tone-extreme",
  "RULE_BOOST_MULT": "rule-boost",

  // --- Color mapping ---
  "COLOR_FAIR_BALANCED": "color-fair-good",
  "COLOR_FAIR_SKEWED": "color-fair-mid",
  "COLOR_FAIR_UNBALANCED": "color-fair-bad",

  // --- Tone color hue ---
  "TONE_BASE_HUE": "tone-base-hue"
};

// helper: read current UI control values
function getParamsFromUI() {
  const out = {};
  for (const [key, id] of Object.entries(paramElems)) {
    const el = document.getElementById(id);
    if (!el) continue;
    out[key] = (el.type === 'color') ? el.value : parseFloat(el.value);
  }
  return out;
}

// =============== SECRET TOGGLE ===============
// Show panel when Shift+D pressed 3x in a row
document.addEventListener("keydown", (e) => {
  if (e.shiftKey && e.key.toLowerCase() === "d") {
    secretCount++;
    if (secretCount >= 3) {
      devVisible = !devVisible;
      devPanel.style.display = devVisible ? "block" : "none";
      secretCount = 0;
      if (devVisible) loadParams();
    }
  } else {
    secretCount = 0;
  }
});

// close button
document.getElementById("close-dev").onclick = () => {
  devVisible = false;
  devPanel.style.display = "none";
};

// =============== TALK TO BACKEND ===============

// fetch current active session params (not defaults)
async function loadParams() {
  const res = await fetch("http://127.0.0.1:8000/dev/params");
  const params = await res.json();
  for (const [key, id] of Object.entries(paramElems)) {
    const elem = document.getElementById(id);
    if (!elem) continue;
    const val = params[key];
    if (val === undefined) continue;
    if (elem.type === "color") {
      elem.value = val;
    } else {
      elem.value = val;
      const display = document.getElementById(id + "-val");
      if (display) display.textContent = val;
    }
  }
}

// push whatever is currently in the sliders / pickers up to backend session
async function applyParams() {
  const updates = getParamsFromUI();
  await fetch("http://127.0.0.1:8000/dev/params", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(updates),
  });
  console.log("‚úÖ Params updated:", updates);

  // üîÅ Auto re-run analysis if text exists
  const t = document.getElementById("inputText");
  if (t && t.value.trim()) {
    await runAnalysis(); // your existing analysis function
  }
}


// ask backend to wipe this user's session back to server defaults
async function resetParams() {
  await fetch("http://127.0.0.1:8000/dev/reset", { method: "POST" });
  await loadParams();
  alert("All tuning reset to server defaults (only for you).");
}

// =============== PRESETS (Lenient / Balanced / Strict) ===============
async function applyPreset(preset) {
  const presets = {
    lenient: {
      BIAS_HIGH_THRESHOLD:0.65, FAIR_BALANCED_MIN:80,
      HOSTILE_PENALTY:30, FAV_PENALTY:20, SUBJ_PENALTY:15,
      CONSTRUCTIVE_BOOST:0.8,
      TONE_VARIANCE_LIMIT:0.4, EXTREME_POLARITY_BIAS_BOOST:0.05, RULE_BOOST_MULT:0.4
    },
    balanced:{
      BIAS_HIGH_THRESHOLD:0.55, FAIR_BALANCED_MIN:85,
      HOSTILE_PENALTY:50, FAV_PENALTY:35, SUBJ_PENALTY:20,
      CONSTRUCTIVE_BOOST:0.6,
      TONE_VARIANCE_LIMIT:0.3, EXTREME_POLARITY_BIAS_BOOST:0.1, RULE_BOOST_MULT:0.5
    },
    strict:  {
      BIAS_HIGH_THRESHOLD:0.45, FAIR_BALANCED_MIN:90,
      HOSTILE_PENALTY:70, FAV_PENALTY:55, SUBJ_PENALTY:35,
      CONSTRUCTIVE_BOOST:0.5,
      TONE_VARIANCE_LIMIT:0.25, EXTREME_POLARITY_BIAS_BOOST:0.15, RULE_BOOST_MULT:0.7
    }
  };
  const p = presets[preset];
  if (!p) return;

  for (const [key,val] of Object.entries(p)) {
    const id = paramElems[key];
    if (!id) continue;
    const el = document.getElementById(id);
    if (!el) continue;
    el.value = val;
    const disp = document.getElementById(id + "-val");
    if (disp) disp.textContent = val;
  }

  // also reflect preset dropdown visually
  document.getElementById("preset-select").value = preset;

  await applyParams();
}

// =============== SAVE PRESET TO FILE ===============
// grab live panel values -> build JSON -> trigger browser download
function downloadPresetJSON() {
  const data = {};
  for (const [key, id] of Object.entries(paramElems)) {
    const el = document.getElementById(id);
    if (!el) continue;
    data[key] = (el.type === "color") ? el.value : parseFloat(el.value);
  }

  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  const stamp = new Date().toISOString().replace(/[:.]/g,"-");
  a.download = `biasbuster-preset-${stamp}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// =============== LOAD PRESET FROM FILE ===============
// open file picker -> read json -> apply to sliders -> push to backend
function promptLoadPresetFile() {
  document.getElementById("preset-file-input").click();
}

document.getElementById("preset-file-input").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  let loaded;
  try {
    loaded = JSON.parse(text);
  } catch (err) {
    alert("Not a valid preset file.");
    return;
  }

  // apply loaded values into UI
  for (const [key,val] of Object.entries(loaded)) {
    const id = paramElems[key];
    if (!id) continue;
    const el = document.getElementById(id);
    if (!el) continue;
    el.value = val;
    const disp = document.getElementById(id + "-val");
    if (disp) disp.textContent = val;
  }

  // mark dropdown as "custom"
  document.getElementById("preset-select").value = "custom";

  // push to backend session
  await applyParams();
  alert("Preset loaded into your session.");
});

// =============== WIRE UP EVENTS ===============
document.getElementById("load-btn").onclick = loadParams;
document.getElementById("reset-btn").onclick = resetParams;
document.getElementById("preset-select").onchange = (e)=>applyPreset(e.target.value);

document.getElementById("save-preset-btn").onclick = downloadPresetJSON;
document.getElementById("load-preset-file-btn").onclick = promptLoadPresetFile;

// live-update backend when sliders/colors move
for (const [key, id] of Object.entries(paramElems)) {
  const el = document.getElementById(id);
  if (!el) continue;
  el.addEventListener("input", async ()=>{
  const disp = document.getElementById(id + "-val");
  if (disp) disp.textContent = el.value;
  document.getElementById("preset-select").value = "custom";
  await applyParams();
  { const t = document.getElementById("inputText"); if (t && t.value.trim()) runAnalysis(); }
  });
}
</script>
<!-- === BiasBuster Lab Mode (Dev Panel) END === -->

<body>
<div class="app">

  <!-- INPUT CARD -->
  <label for="modeSelect">Mode</label>
<select id="modeSelect">
  <option value="feedback" selected>Feedback Mode (assessor)</option>
  <option value="essay">Essay Mode (student)</option>
</select>
<div class="card">
    <h1>BiasBuster 2.2 ‚Ä¢ Tone ¬∑ Bias ¬∑ Balance</h1>
    <p class="subhead">
      <br/><br/><em style="color:#94a3b8;font-size:.75rem;">
Results are advisory only ‚Äî always review flagged feedback manually.
</em>
      Paste assessor comments or essay text. We‚Äôll highlight:<br/>
      ‚Ä¢ Tone (positive / neutral / critical)<br/>
      ‚Ä¢ Bias (low / medium / high)<br/>
      ‚Ä¢ Balance (is feedback professional?)
    </p>

    <label for="inputText">Input text</label>
    <textarea id="inputText" placeholder="Paste text here..."></textarea>

    <button id="runBtn">Run BiasBuster Analysis</button>
  </div>

  <!-- SUMMARY + INLINE VIEW -->
  <div class="summaryGrid">

    <!-- SUMMARY CARD -->
    <div class="card">
      <label>Summary Overview</label>
      <div class="summaryCardInner" id="summaryBox">
        <div class="summaryRow">
          <div class="badgeGroup">
            <div class="badgeLabel">Overall Tone</div>
            <div class="badgeValue" id="toneBadge">
              <span class="dot toneDotNeutral" id="toneDot"></span>
              <span id="overallToneTxt">‚Äî</span>
              <span style="color:var(--text-secondary);font-weight:400;">(<span id="avgPolarityTxt">avg polarity: ‚Äî</span>)</span>
            </div>
          </div>

          <div class="badgeGroup">
            <div class="badgeLabel">Bias Level</div>
            <div class="badgeValue" id="biasBadge">
              <span class="dot biasDotMedium" id="biasDot"></span>
              <span id="biasLevelTxt">‚Äî</span>
              <span style="color:var(--text-secondary);font-weight:400;">(<span id="biasRateTxt">bias rate: ‚Äî</span>)</span>
            </div>
          </div>

          <div class="badgeGroup">
            <div class="badgeLabel">Balance / Fairness</div>
            <div class="badgeValue" id="fairBadge">
              <span class="dot fairDotWarn" id="fairDot"></span>
              <span id="fairnessTxt">‚Äî</span>
              <span style="color:var(--text-secondary);font-weight:400;">(<span id="fairIdxTxt">fairness: ‚Äî</span>)</span>
            </div>
          </div>
        </div>
        

        <div>
          <p class="whatMeansTitle">What this means</p>
          <p class="whatMeansBody" id="meaningTxt">‚Äî</p>
        </div>
      </div>
    </div>

  

    <!-- INLINE HIGHLIGHT CARD -->
    <div class="card">
      <label>Inline Highlight (preview)</label>
      <div id="inlineBox" class="inlineWrapper">
        <div class="dim">(no analysis yet)</div>
      </div>

      <div class="hintRow">
        <div class="hintItem">
          <span class="hintSwatch" style="background:hsl(140,70%,40%);"></span>
          <span>Supportive / balanced</span>
        </div>
        <div class="hintItem">
          <span class="hintSwatch" style="background:hsl(45,85%,55%);"></span>
          <span>Watch wording</span>
        </div>
        <div class="hintItem">
          <span class="hintSwatch" style="background:hsl(0,80%,55%);"></span>
          <span>May feel unfair / personal</span>
        </div>
      </div>
    </div>

  </div>

  <!-- TABLE CARD -->
  <div class="card">
    <label>Sentence View</label>
    <p class="dim" style="margin-top:0;">
      Tone = emotional stance. Bias = subjective or unfair framing. Balance = how professional and student-safe it sounds.
    </p>
    <div class="tableWrapper">
      <table>
        <thead>
          <tr>
            <th style="width:2rem;">#</th>
            <th style="min-width:260px;">Sentence</th>
            <th>Tone</th>
            <th>Bias</th>
            <th>Balance</th>
            <th style="min-width:180px;">Note</th>
          </tr>
        </thead>
        <tbody id="sentTableBody">
          <tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:1rem;">(no data yet)</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const runBtn = document.getElementById("runBtn");
  const inputText = document.getElementById("inputText");
  const inlineBox = document.getElementById("inlineBox");
  const sentTableBody = document.getElementById("sentTableBody");

  // summary elements
  const overallToneTxt = document.getElementById("overallToneTxt");
  const avgPolarityTxt = document.getElementById("avgPolarityTxt");
  const biasLevelTxt = document.getElementById("biasLevelTxt");
  const biasRateTxt = document.getElementById("biasRateTxt");
  const fairnessTxt = document.getElementById("fairnessTxt");
  const fairIdxTxt = document.getElementById("fairIdxTxt");
  const meaningTxt = document.getElementById("meaningTxt");
  const toneDot = document.getElementById("toneDot");
  const biasDot = document.getElementById("biasDot");
  const fairDot = document.getElementById("fairDot");

  function setToneDot(overallTone){
    toneDot.className = "dot " + (
      overallTone === "Positive" ? "toneDotPositive" :
      overallTone === "Negative" ? "toneDotNegative" :
      "toneDotNeutral"
    );
  }

  function setBiasDot(biasLevel){
    const lvl = biasLevel.toLowerCase();
    biasDot.className = "dot " + (
      lvl === "high" ? "biasDotHigh" :
      lvl === "medium" ? "biasDotMedium" :
      "biasDotLow"
    );
  }

  function setFairDot(fairnessOverall){
    const f = fairnessOverall.toLowerCase();
    fairDot.className = "dot " + (
      f === "balanced" ? "fairDotGood" :
      f === "slightly skewed" ? "fairDotWarn" :
      "fairDotBad"
    );
  }

  function escapeHtml(str){
    return str
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function renderSummary(summary){
    if(!summary){
      overallToneTxt.textContent = "‚Äî";
      avgPolarityTxt.textContent = "avg polarity: ‚Äî";
      biasLevelTxt.textContent = "‚Äî";
      biasRateTxt.textContent = "bias rate: ‚Äî";
      fairnessTxt.textContent = "‚Äî";
      fairIdxTxt.textContent = "fairness: ‚Äî";
      meaningTxt.textContent = "‚Äî";
      setToneDot("Neutral");
      setBiasDot("Low");
      setFairDot("Balanced");
      return;
    }

    overallToneTxt.textContent = summary.overall_tone || "‚Äî";
    avgPolarityTxt.textContent = `avg polarity: ${summary.avg_polarity !== undefined ? summary.avg_polarity.toFixed(2) : "‚Äî"}`;
    biasLevelTxt.textContent = summary.avg_bias_level || "‚Äî";
    biasRateTxt.textContent = `bias rate: ${summary.bias_rate !== undefined ? summary.bias_rate + "%" : "‚Äî"}`;
    fairnessTxt.textContent = summary.fairness_overall || "‚Äî";
    fairIdxTxt.textContent = `fairness: ${summary.fairness_index !== undefined ? summary.fairness_index + "%" : "‚Äî"}`;
    meaningTxt.textContent = summary.what_this_means || "‚Äî";
    setToneDot(summary.overall_tone || "Neutral");
    setBiasDot(summary.avg_bias_level || "Low");
    setFairDot(summary.fairness_overall || "Balanced");
  }

  function renderInline(inlineArr){
    if(!inlineArr || !inlineArr.length){
      inlineBox.innerHTML = `<div class="dim">(no analysis yet)</div>`;
      return;
    }

    function pickColor(item){
      if(item.fairColor) return item.fairColor;
      if(item.biasColor) return item.biasColor;
      return item.toneColor || "hsl(45,85%,55%)";
    }

    const spans = inlineArr.map(seg => {
      const safe = escapeHtml(seg.text);
      const bg = pickColor(seg);
      const tooltipHtml = escapeHtml(seg.tooltip || "");
      return `
        <span class="hlSentence" style="background:${bg};">
          ${safe}
          <span class="tooltip">${tooltipHtml}</span>
        </span>
      `;
    });

    inlineBox.innerHTML = spans.join(" ");
  }

  function renderTable(sentences){
    if(!sentences || !sentences.length){
      sentTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:1rem;">(no data yet)</td></tr>`;
      return;
    }

    sentTableBody.innerHTML = sentences.map((s, idx) => {
      const toneBg = s.toneColor || "hsl(45,85%,55%)";
      const biasBg = s.biasColor || "hsl(45,85%,55%)";
      const fairBg = s.fairColor || "hsl(45,85%,55%)";
      const safeSentence = escapeHtml(s.sentence);
      const safeNote = escapeHtml(s.note || "");
      return `
        <tr>
          <td>${idx+1}</td>
          <td class="tdSentence">${safeSentence}</td>
          <td><span class="labelPill" style="background:${toneBg};">${escapeHtml(s.tone_label || "")}</span></td>
          <td><span class="labelPill" style="background:${biasBg};">${escapeHtml(s.bias_class || "")}</span></td>
          <td><span class="labelPill" style="background:${fairBg};">${escapeHtml(s.fairness_label || "")}</span></td>
          <td><div class="noteText">${safeNote}</div></td>
        </tr>
      `;
    }).join("");
  }

  async function runAnalysis(){
    const text = inputText.value.trim();
    if(!text){
      alert("Please paste some text first üôè");
      return;
    }

    const mode = document.getElementById("modeSelect").value;

    const res = await fetch("https://D248-biasbuster-software.hf.space/analyse", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text, mode })
    });

    if(!res.ok){
      alert("API error");
      return;
    }

    const data = await res.json();
    renderSummary(data.summary);
    renderInline(data.inline_highlight);
    renderTable(data.sentences);
  }

  runBtn.addEventListener("click", runAnalysis);
</script>
</body>
</html>
